<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNGTuber</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <img src="./assets/speaking.png" id="png" width="200" height="200">
    <script>
        const { ipcRenderer } = require('electron');

        let micVolumeThreshold = 20; // Default threshold

        ipcRenderer.send('get-config');
        ipcRenderer.on('update-config', (event, config) => {
            micVolumeThreshold = config.threshold;
        });

        navigator.mediaDevices
            .getUserMedia({
                audio: true,
                video: false,
            })
            .then(function (stream) {
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                scriptProcessor.onaudioprocess = function () {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    const arraySum = array.reduce((a, value) => a + value, 0);
                    const average = arraySum / array.length;
                    micVolume = Math.round(average);

                    if (micVolume > micVolumeThreshold) {
                        document.getElementById('png').src = './assets/speaking.png';
                        document.getElementById('png').height = 200 + micVolume;
                    } else {
                        document.getElementById('png').src = './assets/casual.png';
                        document.getElementById('png').height = 200;
                    }
                };
            })
            .catch(function (err) {
                console.error(err);
            });
    </script>
</body>
</html>
